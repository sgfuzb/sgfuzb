<#  
Boot Hole Detection Powershell Script
Copyright (C) 2020, Eclypsium, Inc.
This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.
This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.
You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.

https://github.com/eclypsium/BootHole/blob/master/Powershell/BootHoleDetection.ps1

#>
	
using namespace System.Security.Cryptography.X509Certificates;
using namespace System.Security.Cryptography.HashAlgorithm
using namespace System.Text.Encoding

$VERBOSE = 0

$DBX_Hashes = ("6B6E59284750FC0E6FAC4D6C2A46100E9B0DDE54E000B7327EDD4A4DCED9E9A0"),("62C6AFFBEE1BA9A0435562DB6E092A5018EFFEED0BD0F1D0494F34CE6CD403E9"),("6A6F1C13EEFCBA07C0FC8AA0B70AB6FE2BC709A9EAF83090B735FEC8E0DD576B"),("AEF3E0A113345C1ADCA2D627C5853A11DDFC4E0E07FD28C10049A9B766C0FBC5"),("C7D9DAB91B726DEA5ABAA893D8F60BD4795F489894044DC56A9D3AAD9CC49740"),("9D61099DE8327EFEFF7E4AEA81D9F3396A2218E6B22E15D05032A765897C0EBA"),("0E99607B20D537497169C506C6893243D3F1BD5960505C1566BD97C0A741ADFB"),("191A99A1EF854CE43E64D1CE2FDCC0C942200B88D232F8823A439CBCD7D148C1"),("475552C7476AD45E42344EEE8B30D44C264D200AC2468428AA86FC8795FB6E34"),("8310F47BA34EB1ACA146A5BDB8B59138173E659FBEB57A4C89355D8C54930B6B"),("6A86152DF323185DCD535369C94B9226FEB6AAB4479C00A4A916B4E82E4A85FE"),("24D6B301A1268BA8B373275981538855205EB0115609800F2B5B95377483B108"),("04A779863E698705914958CFCF521450B8D2C9AE321DFE36A2DFDA00AE75ADC1"),("06EDB9F17A9007C8B6DB6EE2FC240E88E238F06C7C983F987CD9BE1B80010D04"),("03C8C9956938147BCC81A19E580CA8B5214E82829EC0494C22B0F59013CA22B2"),("24558C1CB417B6387E2406C70FF13F5438506E8D7560DD7B226499C872C8076F"),("E6CB6A3DCBD85954E5123759461198AF67658AA425A6186FFC9B57B772F9158F"),("777ADC7E8A3E1422B3FC9C10CE31E996C057FE801A5292F0902BD5C5365E7287"),("953A7719B50073E701730FCFF79B2FEE7054C72C54D1F0B0F2571D3CE7FDB925"),("FB5EEBCD4100593A1B2890267037B7701C83F32C284B99908FF1C34D5693BFC2"),("D57F40A0E9018765CD79393A0D57D8E6D6D880D93B95FA57CEDBDA5A0B4A1AE3"),("AA6F27B8B2CA5826F497362042C003B5E1D7CA22383D82730FBC5C45E048D839"),("67FE6B4B726451375E2DC3F87A0954CD01083FB4D8F4FB074BF699536450AF04"),("D809EDDC88A14239E8A069FA71F81F3E4AF4DC293F7575D71D597C80F8767816"),("3F8F266488F3B888EB77B8DF43582FA8124366B7D0670ED78926410F9C9F411F"),("4E371DD0448F1DE869EE087B59FF88D11865463715272BCC6C29B0D5E21DBD82"),("537B428A0AD622765010C4405C1603FF464FCBB24AE4C2FBF559A10B8EA4593D"),("338B89190177E950151A198823FD9D5F4EA25C1FAF73E56CA5D9CF69D373FD66"),("E352109145416E3B61DCF5E09492D24410828121E7D74C08CE0D3157B45A0831"),("0DD832075D552DA3D29B1EF471FC23B47C0D54B9FD1541935B23F1C5813DA08C"),("F8E2A41C0444D7DA76FC1682F3EB7E2A90140E1B68B413F4426BAC357CBE14BB"),("B06DC8F3DE1E7E5A53DC7AD0F8028F78A843DF54884B4A92BCEC21071F0E649B"),("A9F6C38C2608D6F36F246E74A9FD17E915C89E54EAFA2281B8ACE86133DF22B3"),("571B2AA6CA8EDF6479D3472814B8CDF34A0B8544939E5CE9F50261968E382B45"),("127B01B1F605183BBA4D1A07B7EEFE01BA88203A6CD6686B28F3883F33C0ED42"),("DF4E1CF6EAF602F99849DDB6802BD91FB13CD5C3F9FB420250D8A3D750642EFA"),("0E5EB8D0BEBF089A974BC0CA85D33D73F9A0BF72ED2A5E3A62A0387B51D509CE"),("2F871712447DDE7C3552F5AA90A2292821C6F32D92788E00DEE8566F8D4DE209"),("561D28E0888CDB0A8FCE41754742AA8EB1BF5C8DD4EACBF9AF0F40E0D36013C2"),("6E79E3D0580D244C2FC2179A4F08CB80F945AD33D8C4C325DE4E35E0D41584C5"),("3d23947c39680b9fcf22b092b97c9d38edcc02f7ad13d3a925d1ee0b62797e73"),("0ac2943abf5ef953b939247b74331fb2c437e405a81dd5569d9cff1d6183d53a"),("1275826206FEF9AA0A48A60BBC15300B3201F76F45E3CCE3FD0064DE2FC7CC5F"),("8BF4FAC6F3981D1E6180DB0CD53152AE9666DC40884090A522840062E0C926E7"),("5156A8AE596C06692AEF13AC6524C7F1E20D52E4EA0F5A5AD43A6874EDCC5E1F"),("DA31FE4698AD3D0E30408927BE36C938BF52FA9CB8D46B12F84F5D5EC22DD1C6"),("D4D97AEAB61079D3EB0E55794504991DD1BEB0F200315718FFE44BAE89F8F330"),("D92B8AC828B827E4E5B9E9AEB02676783CDB1884F42194823769CCF033A7B9C5"),("A1111555BFDE8807746C8AF73DECEB4BDADC52DEE87004E2AD7239C038687985"),("98ACBA206E9F3843A4A7E07C66EAD4366FBE7976653B65ED0C311D4EFAE878AB"),("56F9E50DA4817B1DE9D9291EB5F2BC63703CA3E6F4A8571BDE28CF756E2C80BA"),("D8E8197BB6CB93157BAE6B4E63EFFA60BB49628DEBB6F771F154C229F4205DB3"),("EF43B4B4A755494B10B7431527AEAD697FEAB6FA48CF4684CCA4FB5B8CD09035"),("8e8addb29426d845a0101c2c1f26c2e7fe8c78128ab04f16cfcb4e06461b0101"),("AD1A9C1667E89214EE947D6B40D61BFFB7EA942ABCCE85319520CC3DE301FA1B"),("E50F1F1E9FB9198E5B094773D1D0068CC1CB1987D06583ABACA20ADC1F8932A9"),("F69D87F5BC30026B00110DADD0264311D15DECE6B67F046506755284AF5EC002"),("608854C2B7A26B00A3970757C2FA176B361F74FE094F7CFA482C439071279548"),("6A3C1124A642244F23685B68D2E5A0AE036651AA401DE70B3912EFD044B62222"),("5613DD1553044BEF74610BC012D676375588421FF0000B69DCF62D1081451ECE"),("6484A487192E0B44CBD30EB7B3D436A9150D5B5AD271974764366BDC4E8677BB"),("1BABF3FB76AE149CCB95B8E33B193CE7408B7134E0A5CC8CE1E884BCD01DFCF2"),("0CE7F3FEC8BBB04E182027DD6800B7993E9F14EB579504DDECDD2F06294D7739"),("D764AC6251FD2641EEBBFBF7A5A95E212DF5997875990D90562CA65D5D966BAE"),("4B2BD93B32DE4BE7235C95C97AF98E12BED5F0602B7B428700F9A1348CB2F731"),("3141C6EF9FCE61084D16F0659A9596B0156F24D6F4B03837C4B7543CFB378D61"),("F88E92940985413ACD440DAA20C08DF99C54613636826D9D95B898D39C44B19B"),("CEF9A1B433C4ED851EC0C373F7E1F19A2B8C306A821D114F177B14E8C070276F"),("9C904F10520295D070DB9CF381101512946AB832C2BD92D4E92D42B934F40DC3"),("20E870697471F16EAC55A9658212F83A7E443CDB3844C7D1901B4D4271828F7D"),("FD1CD4D4A1AC691E7A0AF14C3DFB17DAF3F2E6A2B286C9E233070979EC36BB6F"),("CD0F9839C6CCBEC5CE38B882E1AB23C8AB44A8993E6B8A02026D8314EAC4EA4C"),("E1DC3EF55626A4CF6DDC425A353208F309271B8A9FDBF8964082FB08DFB7A170"),("55A3628537C4FBDA0FA7D27001EB2DFCDC515D8A48649715A31E1D0065A7DA35"),("3F8091F700DA0DD082C6C06D0D3B68DB8D51FBE03198BBD6E4FA0D4A9EACA522"),("EE721020DB7794DE74F59992A2C6B4DCA5B9FD584BBCBDEF96930B9A7132BE1C"),("BA0610793FAA746150C0FD5689158B01DEEEA7320E2F14B31EE9AF4F2C4D1587"),("23EBFBC7BC286CEFC68B4920784B926EC28D7965815238325FBD17892177D6F3"),("8A73B6E52B27695C72D4776C0BCFA54D30C1340D534D5EEFF8D890377CDFDFAA"),("957D8826BEE05DFEA66994C237E61BD70CC0115CC176E1D931F1D892C6C16814"),("52A4F27CCEDCC5405D8EC128BF99861865B2273DA18A9B958ABADEFF63DF5A18"),("83B1D2B20830EE199D8845C999D4680B1B2B6D9C1F424DD13826DA3FA7F7139E"),("BAE97EFC507382C0BDF7B1E74DBC38C0E31BF65186B7989CD9C7AF29DA27F656"),("D8C26A5324CA74212B59B59BEF1BC33FB5B6946DCDDE84414C60A2E315EDE741"),("A7094801F966FC5C253DBD17066AF5BBCB3AF5E281D0A4DAB24E30C7A4B0FB12"),("299E3B66B0283E23793E03FBA6B795A2C6B6034864B6D571449945EBA0D90A20"),("0742A120E871BBB67D6947D05E9301CDACBCCB4AF650464F996B40352CA9699B"),("C31524CF5814D19C11611A5E5C27B2071DCB76B7EC6DC2DEC93FF9DE5CE656DE"),("2B91C0C8C0F156ABC8F85274C1320C038AF0179FE4696260B1011D5361E50AEA"),("CB9E3E372C5F707858E1DE6421C2D3407C240F9D7BC43A9B9F3BA1F6037615B9"),("29DA5912698EE1928C239D394EF95A4BEEF0DC59262B6BFFEC24FA205C4B8A10"),("0692A9566F22F280715080EE24B8FF54ED7372A98BD4994670FCF862035281B5"),("0CA03AD1A65AFE81EC23E2B20E05D80C41AAEB5D6D5F98E2D0C5661F46E0CE9F"),("BA44BD2BB872DD6C6A8687F65CC138585A963473203D6F3F64770E5365812630"),("AA909ADBB83E05F92BA2E1144C6A33CB320A760409E1015B00A9EED666063510"),("CB59D546665D85DC101139E7D26D02A62E0E800DEACCF9555EF0A88B95ABE26A"),("439983268FC8238CB2DC187B033904DBD682929852D846FB69A22DDA1561A422"),("0ED1B0FAE1A6E705D1B116D08B7184E0A2EE2A0E6B0C372CE69B40E9EF34579F"),("5875DB0835E08A9189F23833B21774FDD1C4C3BD4C5D3459471A49B85CFFD1E1"),("EDD0E7C8F136AF180B3A886D06215A0C1D0A6FB7583F79E72A19711BE6419DF8"),("B6C36B2B18A3E73EA007173F8669D9A9A861FDDF27C3E3C0C3F1315E2AE5B43F"),("B76C5689D45E7F40F8D78468D4484074167563CB06368CBB9CB4DBED65E1192A"),("A739C0624B7608F40645D417E79CE0B22FA568D885ACEBE51949F268565098B4"),("F8DFC2F2231FB7E654D4716A56FCDBC82BBF1CA673432F8843CDD378077B8700"),("6E5D8278A7A4A58DBBA2F5D01B09B9DE4BB20ACD2DD4890846C8125A65136BF8"),("88B530624B67FAA0C0C1039618958F4DE983A997A6FF762BCCA82B8201194F28"),("10368826DC89AF42B4AD7E69A9E1F4DA9486DD645C088F445998E8DCA18EB0D4"),("2B7A243AC2248C630A51D73889E4BAA33DA94BD58D63E364A5FEF1A0998B4F5E"),("3AE3DA82C39C6BEEFD251265370D57D5BFC67181662736C62F2E6F687409C81B"),("BBD53435E3881C13F6EF3D7C17DDE9BCCF2BB2D95D303DC4623CD1AA8F51EF23"),("D389EDE1F84051086D30B8C2CFC362797B129854DF1313CA474F83A143F55D11"),("9E5773C34073B8473BD1EBC9D4D50780A7CDF9EB767750107D4B0F45BC8EABE8"),("3D3434BC5A18F072D4CF59D5651F9CE05B61B6FC3C21EBBCF371777AA1E1E1D5"),("77F55C6E07D808021F9E66017605D8B2DED6C55944693641902C4CE821E37878"),("7D092A6101832F2CF3F9DE42C66A9948751B05D3D4005FB9C0E8BDF9B8DAEC6B"),("899AFE09E356003605B30DC209A5BA4EF6910BAEF23FAC268BCAC6DB3CFEE98D"),("C4B5797189521611B809720ED9C4734F1DEC8A2EE2597781FFE438F652A58CE5"),("34440CB45EB6EC2532EF89D6FCD7D3D9BC2A021677BEBC9D65C47A725A6845D4"),("94BDE75194960FAFF8329DCB4462BD8888B32078B0FB8FB2011C6993FDA0316A"),("84A6C5F6C7AC07F1CC405F7B53B69BFF17BE0E4B9A428C21D39DCE0CDD4EF16B"),("2AEC3E859816EFA89AF844D6DD8CCAEA345A851CB23006D3C2928081352BEB25"),("487DF121FD496D9A443C3598DA3771FA187D408C589F4CB990041E546C529539"),("EE39A9A3FBDE8B15CE4AC34519E248EA746A52AE0AE680DA5B0C7EF919E583A3"),("103FE82E5F090184D8DB7A48801D1E503E3C6FC0726783E9A49A84F9FFD4C78A"),("424C636253B4EFA0C69F91505EE16D7079956B8EDE4524FFCE211A1B037FF692"),("7C783057C245A34DFF5A9497C3CD4181FC80D06439884E12AD5D67A4F5266CD6"),("169D0AC3DA1DDA382812F7F221B8C9CD55961A05D876E3D812641313297848BA"),("D57796B512BAA19473D7935C111245CEAA614E37C1D404FAB45FF735ADF245F6"),("F06D3E0F031A2FDC63DD2BA2BE7F32E0D432434C3515C2F840D812FFBFA530F6"),("610D0A80FD4E876EAD581903B33C96ECC4B8BD7115FC9DF5579B3A25416FDAEF"),("707BEEAE9B9CBF0D56AEE48AE398F127D3B52FD37D25B95C561CDA1DB5233C50"),("B40F5FF7030848DB736573E06A1A1C5BF49F119E66DD0BA7E48E2651E2CE7059"),("17F186C88052B988B4C9B62F8D7F55023AC317C82324DD5A958D05B8A1246F77"),("A121947909D35BB042F0049D18E4EE2B27941E10D14E4D6B1C11945CA79992E6"),("EEC3E281A5545CAF11EC02BB0DF159DA19698E639CBA0190A0AEC9AB09296BEB"),("BDD96B78F3AA4B123851342995451880CB2498E785ED12E48CEB36F1A3F49B2B"),("50484376441815F7F85AA294290A9B6072A6A9E8FEAE79447C5C4DE855C5A3D3"),("26A8EBB3EF412AA70D4AB4486EBEE8DB42656AE7F2EC868FA95FA656090F01BE"),("8516257431A250296A10F82A4795F9CF68E5C185CEAA2F6F77CA0942CBE0C999"),("96520E78051325998A6D82FFFEE0366F85289E6D8834D1F3DA9082C6EE146D26"),("459728935C400CBED125A0AA12D0E618CCB6F4FDE3194BB2D06A511DAA335350"),("EC16CFB5AE2297154394D9AB6B5B749DCE676404486D72A44064CD9A716EC1F9"),("0FB12613BC1D4AB6FBB256574EBA9347AE3A87F96E4A3C259028B55CDE1D8053"),("9EABEA9AE699526AD519782DA21718DA7190490AA3436BBBD80269D4A4CC37C5"),("83A5C9C78BC64206AAF7B7F9901867D19BB746201923D855AAE24A2B2330F113"),("690B765C38BE3FBA65B829677D98A67943F92E24E9860EE2A13273F5932B8A0A"),("EDFFF0969567FF1C1867AA921EAA5CF4C65D20F0511BA7EE7328F7B67238DF53"),("C33397B499368E23DDA3FD5B9CC989647442F279EE6F80B53C620721C958346D"),("AD215B731A41CBE37CAFEE5280FFC282A8AC23B5E8BA25DFF3D28A6AAE1D2A0D"),("561694642D87969C00583ED6C4BB6C41527DFF7164A079035E8C8B905A5E4B62"),("5C39F0E5E0E7FA3BE05090813B13D161ACAF48494FDE6233B452C416D29CDDBE"),("AA8DB86BE59A48E4C525DD468119BEBA1D836CE4293C76E4B736902D1AD62F27"),("DF224EF3B05794CBCE084C11BAAF3D85F380A5213D9097E400D9FA42FC412933"),("97BB9FD717C396231E86ECBE5A760D56DBACF4AE8E963D16D724591E45919B65"),("07058C9BBCCB99D58FC93EBE2C007CFE28E1BF74E51954584AA3D3CA06689FBA"),("2F1DAE62EA074FD06DBBF620009CB3E65988D15431A061EAAB4D7ED1A97A3689"),("A95666BFAF48FD9C4CAF2F3ED4EB593145C48BD3C93E4B00638088CE7EE962CF"),("30A947ED2F95D0E7F2746F3A4F3C458FC64554295BA5B4C302FE0EE4F8027C0C"),("EDE70AA6A98D8130019296CE64B5CCF634A997B26401C0E119B96BBF7ACE1C0C"),("6AE5984A47CCE9129498E534DB84F0FD33FE9AEE2860462414416282EB0CF34A"),("407326C7F1C837A861EE8D187170C779A9B6A25B0736761645D7E549EBFA17C2"),("3E4E41310A11DD92A8DAA50AB361CA97B0A9EDB1BFDD38F95ED4553253E61EF7"),("7B5DFE4F9E4EE68E3CDD9C91BCAE26DB334D49AE4C1F9525CECD834DE48DF110"),("0CCD31ED42FF79E74FBA9C064F59F698E3AE9F9E690BE296EA63936E81982000"),("D84AE3F1BB7B2F2C41B986E473AD424CF6F1D136B4E91AA5F73824737169D820"),("A2BE1EB17E12E0A66A87342C9D1CFD4D7DB81504A16B4FCB32F15C6BAA3F589D"),("E4FF4E538B4758E8E49010ED16D6D5380417B146F3E8806ACB3AC40611646FDB"),("FCCC2A01967926437DC0F5F49C6ACEED4DC67EBD7E99169023B5F89A7264CB98"),("9EA346FCFE6DB7F3140DA8FFD5738F6CF97D6014DA61033B32049CB17696B372"),("A120F42DE7B5BFCB55C40AFC857B6BAF4D1AC60725500C27A5B2942BDA970CCF"),("AECD34387179AFF5CE02103679312CDEB1DA835015A8548FCE93765E7219612E"),("862EF2D92E8E0DF128007AEF6F9E4D6A6D0DE3C656A4D72D1A19A18068C23508"),("E33E9D1B1D5ADE1934AC7BD39F0BA4CEAC9459A7E2AABB8D204354D4C8652E6E"),("24AF7036C63F09FEBAB1B84372ECD6151BE32CDC94E80E57F52F7D2C3665FBC4"),("2DF05C41ACC56D0F4C9371DA62EC6CB311C9AFB84B4A4D8C3738583CCC874D38"),("1CC3D6DA3017F0F1422D1B8115622EDEF65FBC497487234D17F4D356670F28EB"),("7C2FDA323F09B9BE6269BA979A620438413EBA4A93B2BA34F9B39998268AD9CD"),("65C4AAB0884825A8A2E4C114020E4FDB58A1D2B0CB68B7714A05D6CDE3F821D1"),("44FD1F90799B852B3BED642DE300BCF9EF6CA81036CD5588C24D5B8E00D4B9D1"),("e0a6813d4020a6a50db26d276f175a942150e346f056a4dba94f17ddce2264f1"),("c194b98bd9a2129a4c1b6044eede090f823535deaab3b48dac2685121c7ca133"),("3f1d987d4573048b4784fdbcb4fad6769f320651b3eddb704472a42b50ac23d0"),("5D6A0CBDAAF188974E98ACA06E664B4AE98D458327717A20B1FF6C80518EEA3D")


$ALERT_USER = 0

#Manual parse command line arguments
for ( $i = 0; $i -lt $args.count; $i++ ) {
	if ($($args[$i]) -eq "-verbose") {$VERBOSE = 1}
	if ($($args[$i]) -eq "-v") {$VERBOSE = 1}
}
#Secure boot information:
if (Confirm-SecureBootUEFI)
{
	#Write-Host -ForegroundColor Green "[+] Secure boot is Enabled"
}
else
{
	#Write-Host -ForegroundColor Red "[+] Secure boot is Disabled"
}


if ($VERBOSE) {Write-Host -ForegroundColor Blue "[+] VERBOSE: Secure boot is enabled!"}
$freeDriveLetter = ls function:[d-z]: -n | ?{ !(test-path $_) } | random
mountvol $freeDriveLetter /S
$hash_util = [System.Security.Cryptography.HashAlgorithm]::Create('sha256')
$files = Get-ChildItem -Path $freeDriveLetter\*.efi -Recurse -Force
foreach ($file in $files)
{
	try
	{	
		
		$bytes = Get-Content $file -Encoding Byte -ReadCount 0
		$file_hash = $hash_util.ComputeHash($bytes) 
		$file_hash_string = -join ($file_hash | % {"{0:X2}" -f $_})
		if ($VERBOSE) {Write-Host -ForegroundColor Blue "[+] VERBOSE: checking file '$file' - SHA256:'$file_hash_string'" }
		if ($DBX_Hashes.Contains($file_hash_string))
		{
			Write-Host -ForegroundColor red "[!] ALERT: Found revoked Binary - '$file'"  
			#print name and path of unsigned file
			$ALERT_USER=1
		}
	}
	catch
	{
		Write-Host -ForegroundColor red "[-] An error has occurred"
	}
}
mountvol $freeDriveLetter /D

if ($ALERT_USER) 
{
	exit 666
	#Write-Host -ForegroundColor Red "[!] ALERT: Revoked binaries have been detected!" 
}
else
{
	exit 0
	#Write-Host -ForegroundColor Green "[+] No revoked binaries were detected"
}
Write-Host 